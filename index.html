<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheques GCA</title>
    
    <!-- React + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Excel con estilos -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDTGKcdIySsHhLUEFwrFtHc0kO6ffnlzJc",
            authDomain: "cheques-gca.firebaseapp.com",
            projectId: "cheques-gca",
            storageBucket: "cheques-gca.firebasestorage.app",
            messagingSenderId: "148135962242",
            appId: "1:148135962242:web:fb2792033c088a4cb1f69b",
            measurementId: "G-8SP84G7983"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                            <h3 className="font-bold text-lg">{title}</h3>
                            <button onClick={onClose} className="text-gray-300 hover:text-white transition">
                                <i className="fa-solid fa-xmark text-xl"></i>
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [empresaActual, setEmpresaActual] = useState('Inmobiliaria del Sur');
            const [busqueda, setBusqueda] = useState('');

            const [filtroEstado, setFiltroEstado] = useState('Todos');
            const [filtroDesde, setFiltroDesde] = useState('');
            const [filtroHasta, setFiltroHasta] = useState('');

            const [errorForm, setErrorForm] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const opcionesCustodia = [
                "Beneficiario",
                "Departamento GDP",
                "Departamento de Sistemas",
                "Departamento de Financiero",
                "Gerencia",
                "Caja Fuerte",
                "Mensajer√≠a/En Tr√°nsito"
            ];

            const [registros, setRegistros] = useState([]);

            const [modalVerOpen, setModalVerOpen] = useState(false);
            const [modalEditarOpen, setModalEditarOpen] = useState(false);
            const [modalMasivaOpen, setModalMasivaOpen] = useState(false);
            const [chequeSeleccionado, setChequeSeleccionado] = useState(null);
            const fileInputRef = useRef(null);

            const [formData, setFormData] = useState({
                numero: '',
                monto: '',
                beneficiario: '',
                estado: 'Emitido',
                custodia: '',
                fecha: new Date().toISOString().split('T')[0],
                obs: ''
            });

            const empresas = [
                'Inmobiliaria del Sur',
                'Grupo Alpha',
                'Holding 5',
                'Log√≠stica Express'
            ];

            // üîπ Logo por empresa (cambia esto a tus rutas reales)
            const logosEmpresa = {
                'Inmobiliaria del Sur': 'logo-inmobiliaria.png',
                'Grupo Alpha': 'logo-grupo-alpha.png',
                'Holding 5': 'logo-holding5.png',
                'Log√≠stica Express': 'logo-logistica.png'
            };

            // === LECTURA EN TIEMPO REAL ===
            useEffect(() => {
                const unsubscribe = db
                    .collection('cheques')
                    .orderBy('empresa')
                    .orderBy('fecha')
                    .onSnapshot(
                        (snapshot) => {
                            const docs = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setRegistros(docs);
                        },
                        (error) => {
                            console.error("Error al leer cheques:", error);
                            alert("Error al leer cheques desde la base de datos.");
                        }
                    );
                return () => unsubscribe();
            }, []);

            // === VALIDACI√ìN ===
            const validarDatosCheque = (datos) => {
                if (
                    !datos.numero ||
                    !datos.monto ||
                    !datos.beneficiario ||
                    !datos.estado ||
                    !datos.custodia ||
                    !datos.fecha
                ) {
                    return "Por favor, completa todos los campos obligatorios.";
                }

                const numeroLimpio = datos.numero.toString().trim();
                if (!/^\d{4,}$/.test(numeroLimpio)) {
                    return "El n√∫mero de cheque debe tener al menos 4 d√≠gitos num√©ricos.";
                }

                if (Number(datos.monto) <= 0) {
                    return "El monto debe ser mayor a 0.";
                }

                return "";
            };

            // === CREAR CHEQUE ===
            const handleSubmit = async (e) => {
                e.preventDefault();
                setErrorForm("");

                const datosParaValidar = {
                    numero: formData.numero,
                    monto: formData.monto,
                    beneficiario: formData.beneficiario,
                    estado: formData.estado,
                    custodia: formData.custodia,
                    fecha: formData.fecha
                };

                const mensajeError = validarDatosCheque(datosParaValidar);
                if (mensajeError) {
                    setErrorForm(mensajeError);
                    return;
                }

                const nuevoCheque = {
                    empresa: empresaActual,
                    numero: formData.numero.trim(),
                    monto: parseFloat(formData.monto) || 0,
                    beneficiario: formData.beneficiario.trim(),
                    estado: formData.estado,
                    custodia: formData.custodia,
                    fecha: formData.fecha,
                    obs: formData.obs.trim()
                };

                try {
                    setIsSubmitting(true);
                    await db.collection('cheques').add(nuevoCheque);
                    setFormData({
                        numero: '',
                        monto: '',
                        beneficiario: '',
                        estado: 'Emitido',
                        custodia: '',
                        fecha: new Date().toISOString().split('T')[0],
                        obs: ''
                    });
                    alert("‚úÖ Cheque registrado en la base de datos");
                } catch (error) {
                    console.error("Error al guardar cheque:", error);
                    alert("‚ùå Error al guardar el cheque. Revisa la consola.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            // === EDITAR (abrir modal) ===
            const abrirEditar = (cheque) => {
                setChequeSeleccionado(cheque);
                setFormData({
                    numero: cheque.numero,
                    monto: cheque.monto,
                    beneficiario: cheque.beneficiario || '',
                    estado: cheque.estado,
                    custodia: cheque.custodia || '',
                    fecha: cheque.fecha,
                    obs: cheque.obs || ''
                });
                setErrorForm("");
                setModalEditarOpen(true);
            };

            // === GUARDAR EDICI√ìN ===
            const guardarEdicion = async (e) => {
                e.preventDefault();
                if (!chequeSeleccionado) return;
                setErrorForm("");

                const datosParaValidar = {
                    numero: formData.numero,
                    monto: formData.monto,
                    beneficiario: formData.beneficiario,
                    estado: formData.estado,
                    custodia: formData.custodia,
                    fecha: formData.fecha
                };

                const mensajeError = validarDatosCheque(datosParaValidar);
                if (mensajeError) {
                    setErrorForm(mensajeError);
                    return;
                }

                const datosEditados = {
                    numero: formData.numero.trim(),
                    monto: parseFloat(formData.monto) || 0,
                    beneficiario: formData.beneficiario.trim(),
                    estado: formData.estado,
                    custodia: formData.custodia,
                    fecha: formData.fecha,
                    obs: formData.obs.trim()
                };

                try {
                    setIsSubmitting(true);
                    await db
                        .collection('cheques')
                        .doc(chequeSeleccionado.id)
                        .update(datosEditados);

                    setModalEditarOpen(false);
                    setChequeSeleccionado(null);
                    setFormData({
                        numero: '',
                        monto: '',
                        beneficiario: '',
                        estado: 'Emitido',
                        custodia: '',
                        fecha: new Date().toISOString().split('T')[0],
                        obs: ''
                    });
                    alert("‚úÖ Cheque actualizado correctamente");
                } catch (error) {
                    console.error("Error al actualizar cheque:", error);
                    alert("‚ùå Error al actualizar el cheque.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            // === ELIMINAR ===
            const eliminarCheque = async () => {
                if (!chequeSeleccionado) return;
                const confirmar = window.confirm(
                    `¬øSeguro que deseas eliminar el cheque ${chequeSeleccionado.numero}?`
                );
                if (!confirmar) return;

                try {
                    setIsSubmitting(true);
                    await db.collection('cheques').doc(chequeSeleccionado.id).delete();
                    setModalEditarOpen(false);
                    setChequeSeleccionado(null);
                    setFormData({
                        numero: '',
                        monto: '',
                        beneficiario: '',
                        estado: 'Emitido',
                        custodia: '',
                        fecha: new Date().toISOString().split('T')[0],
                        obs: ''
                    });
                    alert("üóëÔ∏è Cheque eliminado correctamente");
                } catch (error) {
                    console.error("Error al eliminar cheque:", error);
                    alert("‚ùå Error al eliminar el cheque.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            // === CARGA MASIVA ===
            const procesarCargaMasiva = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(ws);

                        const nuevos = data.map((row) => ({
                            empresa: empresaActual,
                            numero: (row['Numero'] || 'S/N').toString(),
                            monto: parseFloat(row['Monto']) || 0,
                            beneficiario: row['Beneficiario'] || '',
                            estado: row['Estado'] || 'Emitido',
                            custodia: row['Custodia'] || 'Caja Fuerte',
                            fecha: row['Fecha'] || new Date().toISOString().split('T')[0],
                            obs: row['Observaciones'] || 'Carga Masiva'
                        }));

                        const batchPromises = nuevos.map((cheque) =>
                            db.collection('cheques').add(cheque)
                        );
                        await Promise.all(batchPromises);

                        setModalMasivaOpen(false);
                        if (fileInputRef.current) fileInputRef.current.value = "";
                        alert(`‚úÖ Se cargaron ${nuevos.length} cheques a la base de datos.`);
                    } catch (error) {
                        console.error("Error en carga masiva:", error);
                        alert("‚ùå Error al procesar el archivo. Revisa el formato.");
                    }
                };
                reader.readAsBinaryString(file);
            };

            // === REPORTES EXCEL ===
            const descargarExcelIndividual = () => {
                const datosReporte = registros
                    .filter(r => r.empresa === empresaActual)
                    .map(r => ({
                        "Fecha": r.fecha,
                        "N¬∞ Cheque": r.numero,
                        "Beneficiario": r.beneficiario,
                        "Monto": r.monto,
                        "Estado": r.estado,
                        "Custodia": r.custodia,
                        "Observaciones": r.obs
                    }));

                generarExcel(datosReporte, `Reporte_${empresaActual}`, false);
            };

            const descargarReporteGlobal = () => {
                const datosGlobales = [...registros].sort(
                    (a, b) =>
                        a.empresa.localeCompare(b.empresa) ||
                        a.fecha.localeCompare(b.fecha)
                );

                const datosReporte = datosGlobales.map(r => ({
                    "Empresa": r.empresa,
                    "Fecha": r.fecha,
                    "N¬∞ Cheque": r.numero,
                    "Beneficiario": r.beneficiario,
                    "Monto": r.monto,
                    "Estado": r.estado,
                    "Custodia": r.custodia,
                    "Observaciones": r.obs
                }));

                generarExcel(datosReporte, `Reporte_Consolidado_GLOBAL`, true);
            };

            const generarExcel = (datos, nombreArchivo, esGlobal) => {
                const ws = XLSX.utils.json_to_sheet(datos);

                let anchos = [
                    { wch: 12 }, // Fecha
                    { wch: 15 }, // N¬∞ Cheque
                    { wch: 30 }, // Beneficiario
                    { wch: 15 }, // Monto
                    { wch: 15 }, // Estado
                    { wch: 25 }, // Custodia
                    { wch: 30 }  // Observaciones
                ];

                if (esGlobal) {
                    anchos = [
                        { wch: 25 }, // Empresa
                        ...anchos
                    ];
                }

                ws['!cols'] = anchos;

                const range = XLSX.utils.decode_range(ws['!ref']);
                const colMonto = esGlobal ? 4 : 3;

                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cell_address]) continue;

                        let style = {
                            border: {
                                top: { style: "thin" },
                                bottom: { style: "thin" },
                                left: { style: "thin" },
                                right: { style: "thin" }
                            },
                            font: { name: "Arial", sz: 10 }
                        };

                        if (R === 0) {
                            style.fill = {
                                fgColor: { rgb: esGlobal ? "581c87" : "1e40af" }
                            };
                            style.font = {
                                name: "Arial",
                                sz: 11,
                                bold: true,
                                color: { rgb: "FFFFFF" }
                            };
                            style.alignment = {
                                horizontal: "center",
                                vertical: "center"
                            };
                        }

                        if (C === colMonto && R > 0) {
                            style.numFmt = '"$"#,##0.00';
                            style.alignment = { horizontal: "right" };
                        }

                        ws[cell_address].s = style;
                    }
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reporte");
                XLSX.writeFile(
                    wb,
                    `${nombreArchivo}_${new Date().toISOString().slice(0, 10)}.xlsx`
                );
            };

            const descargarPlantilla = () => {
                const data = [{
                    Numero: "001",
                    Monto: 100,
                    Beneficiario: "Ejemplo",
                    Estado: "Emitido",
                    Custodia: "Departamento GDP",
                    Fecha: "2023-12-01",
                    Observaciones: "Prueba"
                }];
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Plantilla');
                XLSX.writeFile(wb, "Plantilla_Carga.xlsx");
            };

            const getColorEstado = (estado) => {
                if (estado === 'En Blanco (FIRMADO)') return 'bg-red-100 text-red-700 border-red-200 font-bold';
                if (estado === 'Cobrado') return 'bg-green-100 text-green-700 border-green-200';
                if (estado === 'Anulado') return 'bg-gray-200 text-gray-500 line-through';
                return 'bg-blue-50 text-blue-700 border-blue-200';
            };

            // === FILTRO TABLA ===
            const registrosFiltrados = registros.filter(r => {
                if (r.empresa !== empresaActual) return false;

                const numeroStr = (r.numero || '').toString();
                const beneficiarioStr = (r.beneficiario || '').toLowerCase();
                const textoBusqueda = busqueda.toLowerCase();

                if (textoBusqueda) {
                    const coincideNumero = numeroStr.includes(textoBusqueda);
                    const coincideBeneficiario = beneficiarioStr.includes(textoBusqueda);
                    if (!coincideNumero && !coincideBeneficiario) return false;
                }

                if (filtroEstado !== 'Todos' && r.estado !== filtroEstado) {
                    return false;
                }

                if (filtroDesde && r.fecha < filtroDesde) return false;
                if (filtroHasta && r.fecha > filtroHasta) return false;

                return true;
            });

            return (
                <div className="min-h-screen flex flex-col">
                    {/* NAVBAR */}
                    <nav className="bg-slate-800 text-white p-4 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-10">
                        {/* IZQUIERDA: LOGO + NOMBRE (logo cambia por empresa) */}
                        <div className="flex items-center gap-3">
                            <div className="bg-white rounded-lg p-1 flex items-center justify-center w-11 h-11">
                                <img
                                    src={logosEmpresa[empresaActual] || 'logo-default.png'}
                                    alt={empresaActual}
                                    className="w-9 h-9 object-contain"
                                />
                            </div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight flex items-center gap-2">
                                    <span>Cheques</span>
                                    <span className="text-blue-400">GCA</span>
                                    <span className="hidden sm:inline text-[11px] font-normal text-slate-300 border border-slate-500/60 rounded-full px-2 py-[2px] ml-1">
                                        {empresaActual}
                                    </span>
                                </h1>
                                <p className="text-xs text-slate-400">
                                    Control y Reportes Globales
                                </p>
                            </div>
                        </div>

                        {/* DERECHA: Reporte global + selector empresa */}
                        <div className="flex gap-4">
                            <button
                                onClick={descargarReporteGlobal}
                                className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider shadow-lg flex items-center gap-2 border border-purple-500"
                            >
                                <i className="fa-solid fa-earth-americas"></i> Reporte Global
                            </button>

                            <div className="flex items-center gap-2 bg-slate-700 px-4 py-2 rounded-lg border border-slate-600">
                                <span className="text-xs text-slate-300 uppercase font-bold tracking-wider">
                                    Empresa:
                                </span>
                                <select
                                    value={empresaActual}
                                    onChange={(e) => setEmpresaActual(e.target.value)}
                                    className="bg-transparent font-bold outline-none cursor-pointer text-white"
                                >
                                    {empresas.map(e => (
                                        <option key={e} value={e} className="text-black">
                                            {e}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </nav>

                    {/* CONTENIDO PRINCIPAL */}
                    <div className="flex-1 p-6 max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* FORMULARIO */}
                        <div className="lg:col-span-4 xl:col-span-3 space-y-6">
                            <div className="bg-white p-5 rounded-xl shadow-md border border-slate-200 sticky top-24">
                                <h2 className="text-sm font-bold text-slate-500 uppercase mb-4 border-b pb-2">
                                    Registro en {empresaActual}
                                </h2>

                                {errorForm && (
                                    <div className="mb-3 text-xs bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg flex items-start gap-2">
                                        <i className="fa-solid fa-circle-exclamation mt-0.5"></i>
                                        <span>{errorForm}</span>
                                    </div>
                                )}

                                <form onSubmit={handleSubmit} className="space-y-3">
                                    <input
                                        type="text"
                                        placeholder="N√∫mero Cheque"
                                        className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={formData.numero}
                                        onChange={e => setFormData({ ...formData, numero: e.target.value })}
                                        required
                                    />

                                    <div className="grid grid-cols-2 gap-2">
                                        <select
                                            className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                            value={formData.estado}
                                            onChange={e => setFormData({ ...formData, estado: e.target.value })}
                                            required
                                        >
                                            <option value="Emitido">Emitido</option>
                                            <option value="Cobrado">Cobrado</option>
                                            <option value="En Blanco (FIRMADO)">‚ö†Ô∏è FIRMADO</option>
                                            <option value="En Blanco (Vac√≠o)">Vac√≠o</option>
                                            <option value="Anulado">Anulado</option>
                                        </select>
                                        <input
                                            type="date"
                                            className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={formData.fecha}
                                            onChange={e => setFormData({ ...formData, fecha: e.target.value })}
                                            required
                                        />
                                    </div>

                                    <input
                                        type="number"
                                        placeholder="Monto ($)"
                                        step="0.01"
                                        className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={formData.monto}
                                        onChange={e => setFormData({ ...formData, monto: e.target.value })}
                                        required
                                    />

                                    <input
                                        type="text"
                                        placeholder="Beneficiario"
                                        className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={formData.beneficiario}
                                        onChange={e => setFormData({ ...formData, beneficiario: e.target.value })}
                                        required
                                    />

                                    <div className="relative">
                                        <i className="fa-solid fa-user-shield absolute top-3 left-2 text-slate-400 text-xs z-10"></i>
                                        <select
                                            className="w-full pl-7 p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-yellow-50 cursor-pointer appearance-none"
                                            value={formData.custodia}
                                            onChange={e => setFormData({ ...formData, custodia: e.target.value })}
                                            required
                                        >
                                            <option value="">Seleccionar Custodia...</option>
                                            {opcionesCustodia.map(op => (
                                                <option key={op} value={op}>{op}</option>
                                            ))}
                                        </select>
                                        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                            <i className="fa-solid fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>

                                    <textarea
                                        placeholder="Observaciones"
                                        className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        rows="2"
                                        value={formData.obs}
                                        onChange={e => setFormData({ ...formData, obs: e.target.value })}
                                    ></textarea>

                                    <button
                                        type="submit"
                                        disabled={isSubmitting}
                                        className={`w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition text-sm flex items-center justify-center gap-2 ${isSubmitting ? 'opacity-60 cursor-not-allowed' : ''}`}
                                    >
                                        {isSubmitting && <i className="fa-solid fa-spinner fa-spin text-xs"></i>}
                                        Guardar Cheque
                                    </button>
                                </form>
                            </div>
                        </div>

                        {/* TABLA + FILTROS */}
                        <div className="lg:col-span-8 xl:col-span-9 space-y-4">
                            {/* Barra 1: b√∫squeda + acciones */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                <div className="flex flex-col sm:flex-row gap-4 justify-between items-center">
                                    <div className="relative w-full sm:w-64">
                                        <i className="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                                        <input
                                            type="text"
                                            placeholder="Buscar por n√∫mero o beneficiario..."
                                            className="w-full pl-9 pr-4 py-2 bg-slate-50 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-200 outline-none"
                                            value={busqueda}
                                            onChange={e => setBusqueda(e.target.value)}
                                        />
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setModalMasivaOpen(true)}
                                            className="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm font-bold transition"
                                        >
                                            <i className="fa-solid fa-upload"></i>
                                        </button>
                                        <button
                                            onClick={descargarExcelIndividual}
                                            className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm font-bold transition shadow-md"
                                        >
                                            <i className="fa-solid fa-file-excel"></i> Excel {empresaActual}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Barra 2: filtros por estado y fechas */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                <div className="flex flex-col sm:flex-row gap-4 items-center justify-between">
                                    <div className="flex flex-wrap gap-2 items-center">
                                        <label className="text-xs font-semibold text-slate-500">Estado:</label>
                                        <select
                                            className="border rounded-lg px-2 py-1 text-xs bg-white"
                                            value={filtroEstado}
                                            onChange={e => setFiltroEstado(e.target.value)}
                                        >
                                            <option value="Todos">Todos los estados</option>
                                            <option value="Emitido">Emitido</option>
                                            <option value="Cobrado">Cobrado</option>
                                            <option value="En Blanco (FIRMADO)">Firmado en blanco</option>
                                            <option value="En Blanco (Vac√≠o)">Vac√≠o</option>
                                            <option value="Anulado">Anulado</option>
                                        </select>
                                    </div>

                                    <div className="flex flex-wrap gap-2 items-center">
                                        <span className="text-xs font-semibold text-slate-500">Rango de fechas:</span>
                                        <input
                                            type="date"
                                            className="border rounded-lg px-2 py-1 text-xs"
                                            value={filtroDesde}
                                            onChange={e => setFiltroDesde(e.target.value)}
                                        />
                                        <span className="text-xs text-slate-400">a</span>
                                        <input
                                            type="date"
                                            className="border rounded-lg px-2 py-1 text-xs"
                                            value={filtroHasta}
                                            onChange={e => setFiltroHasta(e.target.value)}
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Tabla */}
                            <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                                            <tr>
                                                <th className="p-4 border-b">Fecha</th>
                                                <th className="p-4 border-b">N¬∞</th>
                                                <th className="p-4 border-b">Beneficiario</th>
                                                <th className="p-4 border-b">Custodia</th>
                                                <th className="p-4 border-b">Estado</th>
                                                <th className="p-4 border-b text-right">Monto</th>
                                                <th className="p-4 border-b text-center"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm divide-y divide-slate-100">
                                            {registrosFiltrados.map(r => (
                                                <tr key={r.id} className="hover:bg-slate-50 transition-colors">
                                                    <td className="p-4 text-slate-600 whitespace-nowrap">{r.fecha}</td>
                                                    <td className="p-4 font-mono font-bold text-slate-700">{r.numero}</td>
                                                    <td className="p-4 text-slate-800 max-w-xs truncate">
                                                        {r.beneficiario || '-'}
                                                    </td>
                                                    <td className="p-4 text-xs">
                                                        {r.custodia ? (
                                                            <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200 font-medium whitespace-nowrap">
                                                                <i className="fa-solid fa-user-tag mr-1"></i>
                                                                {r.custodia.split('(')[0]}
                                                            </span>
                                                        ) : (
                                                            <span className="text-slate-300">-</span>
                                                        )}
                                                    </td>
                                                    <td className="p-4">
                                                        <span className={`px-2 py-1 rounded-md text-xs border ${getColorEstado(r.estado)} whitespace-nowrap`}>
                                                            {r.estado}
                                                        </span>
                                                    </td>
                                                    <td className="p-4 text-right font-bold text-slate-700">
                                                        ${Number(r.monto || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}
                                                    </td>
                                                    <td className="p-4 flex justify-center gap-1">
                                                        <button
                                                            onClick={() => { setChequeSeleccionado(r); setModalVerOpen(true); }}
                                                            className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                                        >
                                                            <i className="fa-solid fa-eye"></i>
                                                        </button>
                                                        <button
                                                            onClick={() => abrirEditar(r)}
                                                            className="p-2 text-amber-600 hover:bg-amber-50 rounded"
                                                        >
                                                            <i className="fa-solid fa-pen"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {registrosFiltrados.length === 0 && (
                                                <tr>
                                                    <td colSpan="7" className="p-8 text-center text-slate-400">
                                                        No hay datos en {empresaActual} con los filtros seleccionados.
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* MODAL VER FICHA */}
                    <Modal
                        isOpen={modalVerOpen}
                        onClose={() => setModalVerOpen(false)}
                        title="Ficha del Cheque"
                    >
                        {chequeSeleccionado && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-start bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    <div>
                                        <p className="text-xs text-slate-400 uppercase">Empresa</p>
                                        <p className="font-bold text-slate-800">
                                            {chequeSeleccionado.empresa}
                                        </p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xs text-slate-400 uppercase">Valor</p>
                                        <p className="text-2xl font-bold text-blue-600">
                                            ${Number(chequeSeleccionado.monto || 0).toLocaleString()}
                                        </p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-xs text-slate-400 uppercase">Estado</p>
                                        <span className={`inline-block mt-1 px-3 py-1 rounded-full text-xs font-bold border ${getColorEstado(chequeSeleccionado.estado)}`}>
                                            {chequeSeleccionado.estado}
                                        </span>
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-400 uppercase">Custodia</p>
                                        <p className="font-bold text-slate-700 mt-1">
                                            <i className="fa-solid fa-user-shield text-yellow-500 mr-2"></i>
                                            {chequeSeleccionado.custodia}
                                        </p>
                                    </div>
                                </div>
                                <hr className="border-slate-100" />
                                <div>
                                    <p className="text-xs text-slate-400 uppercase">N¬∞ Cheque</p>
                                    <p className="font-mono text-xl">
                                        {chequeSeleccionado.numero}
                                    </p>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-400 uppercase">Beneficiario</p>
                                    <p className="font-medium text-lg">
                                        {chequeSeleccionado.beneficiario || '-'}
                                    </p>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-400 uppercase">Observaciones</p>
                                    <p className="bg-slate-50 p-3 rounded text-sm text-slate-600 mt-1 italic">
                                        "{chequeSeleccionado.obs || 'Sin observaciones'}"
                                    </p>
                                </div>
                            </div>
                        )}
                    </Modal>

                    {/* MODAL EDITAR */}
                    <Modal
                        isOpen={modalEditarOpen}
                        onClose={() => setModalEditarOpen(false)}
                        title="Editar Informaci√≥n"
                    >
                        <form onSubmit={guardarEdicion} className="space-y-4">
                            {errorForm && (
                                <div className="mb-2 text-xs bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg flex items-start gap-2">
                                    <i className="fa-solid fa-circle-exclamation mt-0.5"></i>
                                    <span>{errorForm}</span>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500">N√∫mero</label>
                                    <input
                                        type="text"
                                        className="w-full p-2 border rounded"
                                        value={formData.numero}
                                        onChange={e => setFormData({ ...formData, numero: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500">Monto</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="w-full p-2 border rounded"
                                        value={formData.monto}
                                        onChange={e => setFormData({ ...formData, monto: e.target.value })}
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500">Estado</label>
                                    <select
                                        className="w-full p-2 border rounded bg-white"
                                        value={formData.estado}
                                        onChange={e => setFormData({ ...formData, estado: e.target.value })}
                                    >
                                        <option value="Emitido">Emitido</option>
                                        <option value="Cobrado">Cobrado</option>
                                        <option value="En Blanco (FIRMADO)">‚ö†Ô∏è FIRMADO EN BLANCO</option>
                                        <option value="Anulado">Anulado</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500">Fecha</label>
                                    <input
                                        type="date"
                                        className="w-full p-2 border rounded"
                                        value={formData.fecha}
                                        onChange={e => setFormData({ ...formData, fecha: e.target.value })}
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-500">Custodia</label>
                                <select
                                    className="w-full p-2 border rounded bg-yellow-50"
                                    value={formData.custodia}
                                    onChange={e => setFormData({ ...formData, custodia: e.target.value })}
                                >
                                    <option value="">Seleccionar...</option>
                                    {opcionesCustodia.map(op => (
                                        <option key={op} value={op}>{op}</option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-500">Beneficiario</label>
                                <input
                                    type="text"
                                    className="w-full p-2 border rounded"
                                    value={formData.beneficiario}
                                    onChange={e => setFormData({ ...formData, beneficiario: e.target.value })}
                                />
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-500">Observaciones</label>
                                <textarea
                                    className="w-full p-2 border rounded"
                                    rows="3"
                                    value={formData.obs}
                                    onChange={e => setFormData({ ...formData, obs: e.target.value })}
                                ></textarea>
                            </div>

                            <div className="flex gap-2">
                                <button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className={`flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 ${isSubmitting ? 'opacity-60 cursor-not-allowed' : ''}`}
                                >
                                    {isSubmitting && <i className="fa-solid fa-spinner fa-spin text-xs"></i>}
                                    Guardar Cambios
                                </button>
                                <button
                                    type="button"
                                    onClick={eliminarCheque}
                                    disabled={isSubmitting}
                                    className={`px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 border ${
                                        isSubmitting
                                            ? 'opacity-60 cursor-not-allowed bg-red-100 text-red-500 border-red-200'
                                            : 'bg-red-50 text-red-600 border-red-300 hover:bg-red-100'
                                    }`}
                                >
                                    <i className="fa-solid fa-trash"></i>
                                    Eliminar
                                </button>
                            </div>
                        </form>
                    </Modal>

                    {/* MODAL CARGA MASIVA */}
                    <Modal
                        isOpen={modalMasivaOpen}
                        onClose={() => setModalMasivaOpen(false)}
                        title="Importar Excel"
                    >
                        <div className="space-y-6 text-center">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                                <p>Plantilla actualizada.</p>
                                <button
                                    onClick={descargarPlantilla}
                                    className="mt-2 text-blue-600 font-bold underline hover:text-blue-800"
                                >
                                    <i className="fa-solid fa-download"></i> Descargar Plantilla
                                </button>
                            </div>
                            <div className="border-2 border-dashed border-slate-300 rounded-xl p-8 hover:bg-slate-50 transition cursor-pointer relative">
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={procesarCargaMasiva}
                                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    accept=".xlsx, .xls, .csv"
                                />
                                <i className="fa-solid fa-cloud-arrow-up text-4xl text-slate-400 mb-2"></i>
                                <p className="font-bold text-slate-600">Subir Excel Aqu√≠</p>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
